// =============================================================================
// BALANCOFFEE SYSTEM TEST & VERIFICATION SCRIPT
// =============================================================================

console.log('üß™ Starting BalanCoffee System Test...');

// Test data
const testMenuItems = [
    { id: 1, name: 'C√† ph√™ ƒëen', price: 15000, category: 'coffee' },
    { id: 2, name: 'C√† ph√™ s·ªØa', price: 18000, category: 'coffee' },
    { id: 3, name: 'Tr√† ƒë√†o cam s·∫£', price: 25000, category: 'tea' }
];

// Mock DOM elements for testing
function createMockDOM() {
    console.log('üèóÔ∏è Creating mock DOM elements...');
    
    // Create basic container
    if (!document.body) {
        document.body = document.createElement('body');
    }
    
    // Create sidebar
    const sidebar = document.createElement('div');
    sidebar.id = 'sidebar';
    sidebar.className = 'sidebar collapsed';
    document.body.appendChild(sidebar);
    
    // Create invoice list
    const invoiceList = document.createElement('div');
    invoiceList.id = 'invoice-list';
    sidebar.appendChild(invoiceList);
    
    // Create sidebar controls
    const sidebarControls = document.createElement('div');
    sidebarControls.id = 'sidebar-controls';
    sidebarControls.style.display = 'none';
    sidebar.appendChild(sidebarControls);
    
    // Create current order display
    const currentOrderEl = document.createElement('div');
    currentOrderEl.id = 'current-order';
    document.body.appendChild(currentOrderEl);
    
    // Create order count
    const orderCount = document.createElement('span');
    orderCount.id = 'order-count';
    document.body.appendChild(orderCount);
    
    // Create invoice count
    const invoiceCountEl = document.createElement('span');
    invoiceCountEl.id = 'invoice-count';
    document.body.appendChild(invoiceCountEl);
    
    // Create shift displays
    const shiftStartDisplay = document.createElement('span');
    shiftStartDisplay.id = 'shift-start-display';
    document.body.appendChild(shiftStartDisplay);
    
    const shiftEmployeeDisplay = document.createElement('span');
    shiftEmployeeDisplay.id = 'shift-employee-display';
    document.body.appendChild(shiftEmployeeDisplay);
    
    console.log('‚úÖ Mock DOM created');
}

// Test Functions
function testInvoiceOperations() {
    console.log('\nüìã Testing Invoice Operations...');
    
    try {
        // Clear existing data
        window.invoices = [];
        window.currentOrder = [];
        window.currentInvoiceId = null;
        
        // Test 1: Create new invoice
        console.log('1. Testing createNewInvoice()...');
        const newInvoice = createNewInvoice();
        
        if (newInvoice && newInvoice.id && window.invoices.length === 1) {
            console.log('‚úÖ Create new invoice: PASSED');
        } else {
            console.log('‚ùå Create new invoice: FAILED');
            return false;
        }
        
        // Test 2: Add items to order
        console.log('2. Testing addToOrder()...');
        addToOrder(1); // Add coffee
        addToOrder(2); // Add milk coffee
        
        if (window.currentOrder.length === 2) {
            console.log('‚úÖ Add to order: PASSED');
        } else {
            console.log('‚ùå Add to order: FAILED');
            return false;
        }
        
        // Test 3: Update quantities
        console.log('3. Testing quantity updates...');
        increaseQuantity(1);
        
        const coffeeItem = window.currentOrder.find(item => item.id === 1);
        if (coffeeItem && coffeeItem.quantity === 2) {
            console.log('‚úÖ Increase quantity: PASSED');
        } else {
            console.log('‚ùå Increase quantity: FAILED');
            return false;
        }
        
        decreaseQuantity(1);
        if (coffeeItem.quantity === 1) {
            console.log('‚úÖ Decrease quantity: PASSED');
        } else {
            console.log('‚ùå Decrease quantity: FAILED');
            return false;
        }
        
        // Test 4: Edit invoice
        console.log('4. Testing editInvoice()...');
        const invoiceId = window.invoices[0].id;
        editInvoice(invoiceId);
        
        if (window.currentInvoiceId === invoiceId && window.invoices[0].isEditing) {
            console.log('‚úÖ Edit invoice: PASSED');
        } else {
            console.log('‚ùå Edit invoice: FAILED');
            return false;
        }
        
        // Test 5: Finish edit
        console.log('5. Testing finishEditInvoice()...');
        finishEditInvoice(invoiceId);
        
        if (!window.currentInvoiceId && !window.invoices[0].isEditing) {
            console.log('‚úÖ Finish edit invoice: PASSED');
        } else {
            console.log('‚ùå Finish edit invoice: FAILED');
            return false;
        }
        
        // Test 6: Delete invoice
        console.log('6. Testing deleteInvoiceById()...');
        const initialCount = window.invoices.length;
        // Mock confirm to return true
        const originalConfirm = window.confirm;
        window.confirm = () => true;
        
        deleteInvoiceById(invoiceId);
        window.confirm = originalConfirm;
        
        if (window.invoices.length === initialCount - 1) {
            console.log('‚úÖ Delete invoice: PASSED');
        } else {
            console.log('‚ùå Delete invoice: FAILED');
            return false;
        }
        
        console.log('‚úÖ All Invoice Operations: PASSED\n');
        return true;
        
    } catch (error) {
        console.log('‚ùå Invoice Operations Error:', error.message);
        return false;
    }
}

function testShiftOperations() {
    console.log('\nüë§ Testing Shift Operations...');
    
    try {
        // Clear shift data
        window.shiftStartTime = null;
        window.currentShiftEmployee = null;
        window.currentShiftNote = null;
        
        // Test 1: Start new shift
        console.log('1. Testing proceedWithNewShift()...');
        // Mock confirm to return true
        const originalConfirm = window.confirm;
        window.confirm = () => true;
        
        proceedWithNewShift('Nguy·ªÖn VƒÉn A', 'Ca s√°ng');
        window.confirm = originalConfirm;
        
        if (window.shiftStartTime && window.currentShiftEmployee === 'Nguy·ªÖn VƒÉn A') {
            console.log('‚úÖ Start new shift: PASSED');
        } else {
            console.log('‚ùå Start new shift: FAILED');
            return false;
        }
        
        // Test 2: Update shift info display
        console.log('2. Testing updateShiftInfoDisplay()...');
        updateShiftInfoDisplay();
        
        console.log('‚úÖ Update shift info: PASSED');
        
        // Test 3: Get current shift orders
        console.log('3. Testing getCurrentShiftOrders()...');
        const currentOrders = getCurrentShiftOrders();
        
        if (Array.isArray(currentOrders)) {
            console.log('‚úÖ Get current shift orders: PASSED');
        } else {
            console.log('‚ùå Get current shift orders: FAILED');
            return false;
        }
        
        console.log('‚úÖ All Shift Operations: PASSED\n');
        return true;
        
    } catch (error) {
        console.log('‚ùå Shift Operations Error:', error.message);
        return false;
    }
}

function testUIOperations() {
    console.log('\nüñ•Ô∏è Testing UI Operations...');
    
    try {
        // Test 1: Toggle sidebar
        console.log('1. Testing toggleSidebar()...');
        const sidebar = document.getElementById('sidebar');
        const initialState = sidebar.classList.contains('collapsed');
        
        toggleSidebar();
        
        if (sidebar.classList.contains('collapsed') !== initialState) {
            console.log('‚úÖ Toggle sidebar: PASSED');
        } else {
            console.log('‚ùå Toggle sidebar: FAILED');
            return false;
        }
        
        // Test 2: Show/hide sidebar controls
        console.log('2. Testing sidebar controls...');
        showSidebarControls();
        const controls = document.getElementById('sidebar-controls');
        
        if (controls.style.display === 'flex') {
            console.log('‚úÖ Show sidebar controls: PASSED');
        } else {
            console.log('‚ùå Show sidebar controls: FAILED');
            return false;
        }
        
        hideSidebarControls();
        if (controls.style.display === 'none') {
            console.log('‚úÖ Hide sidebar controls: PASSED');
        } else {
            console.log('‚ùå Hide sidebar controls: FAILED');
            return false;
        }
        
        // Test 3: Update displays
        console.log('3. Testing update displays...');
        updateInvoiceDisplay();
        updateOrderDisplay();
        updateInvoiceCount();
        
        console.log('‚úÖ Update displays: PASSED');
        
        console.log('‚úÖ All UI Operations: PASSED\n');
        return true;
        
    } catch (error) {
        console.log('‚ùå UI Operations Error:', error.message);
        return false;
    }
}

function testDataPersistence() {
    console.log('\nüíæ Testing Data Persistence...');
    
    try {
        // Test 1: Save and load invoices
        console.log('1. Testing invoice persistence...');
        window.invoices = [
            {
                id: 'HD123456',
                items: [{ id: 1, name: 'Test Coffee', price: 15000, quantity: 2 }],
                total: 30000,
                status: 'pending',
                createdAt: new Date().toISOString()
            }
        ];
        
        saveInvoices();
        window.invoices = [];
        loadInvoices();
        
        if (window.invoices.length === 1 && window.invoices[0].id === 'HD123456') {
            console.log('‚úÖ Invoice persistence: PASSED');
        } else {
            console.log('‚ùå Invoice persistence: FAILED');
            return false;
        }
        
        // Test 2: Save and load shift data
        console.log('2. Testing shift persistence...');
        saveShiftEmployee('Test Employee', 'Test Note');
        window.currentShiftEmployee = null;
        loadShiftEmployee();
        
        if (window.currentShiftEmployee === 'Test Employee') {
            console.log('‚úÖ Shift persistence: PASSED');
        } else {
            console.log('‚ùå Shift persistence: FAILED');
            return false;
        }
        
        console.log('‚úÖ All Data Persistence: PASSED\n');
        return true;
        
    } catch (error) {
        console.log('‚ùå Data Persistence Error:', error.message);
        return false;
    }
}

// Main test runner
function runAllTests() {
    console.log('üöÄ BalanCoffee System Test Started\n');
    console.log('================================');
    
    createMockDOM();
    
    const results = {
        invoice: testInvoiceOperations(),
        shift: testShiftOperations(),
        ui: testUIOperations(),
        persistence: testDataPersistence()
    };
    
    console.log('\nüìä TEST RESULTS SUMMARY');
    console.log('================================');
    console.log(`Invoice Operations: ${results.invoice ? '‚úÖ PASSED' : '‚ùå FAILED'}`);
    console.log(`Shift Operations: ${results.shift ? '‚úÖ PASSED' : '‚ùå FAILED'}`);
    console.log(`UI Operations: ${results.ui ? '‚úÖ PASSED' : '‚ùå FAILED'}`);
    console.log(`Data Persistence: ${results.persistence ? '‚úÖ PASSED' : '‚ùå FAILED'}`);
    
    const allPassed = Object.values(results).every(result => result === true);
    
    console.log('\nüéØ OVERALL RESULT');
    console.log('================================');
    if (allPassed) {
        console.log('‚úÖ ALL TESTS PASSED - System Ready for Production!');
        console.log('üéâ BalanCoffee system is fully functional');
    } else {
        console.log('‚ùå SOME TESTS FAILED - Requires attention');
        console.log('‚ö†Ô∏è Check individual test results above');
    }
    
    return allPassed;
}

// Export for use
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { runAllTests };
} else if (typeof window !== 'undefined') {
    window.runBalanCoffeeTests = runAllTests;
}

console.log('üìã Test script loaded. Call runAllTests() to start testing.');
