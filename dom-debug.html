<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOM Debug - BalanCoffee</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { margin: 5px; padding: 8px 16px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
        .element-check { margin: 5px 0; }
        .found { color: green; }
        .missing { color: red; }
        .hidden { color: orange; }
    </style>
</head>
<body>
    <h1>BalanCoffee DOM Debug Tool</h1>
    
    <div class="debug-section">
        <h2>Control Panel</h2>
        <button onclick="runFullDOMCheck()">🔍 Full DOM Check</button>
        <button onclick="loadMainApp()">🚀 Load Main App</button>
        <button onclick="checkScriptLoading()">📜 Check Scripts</button>
        <button onclick="clearLogs()">🧹 Clear Logs</button>
        <button onclick="exportDebugReport()">📋 Export Report</button>
    </div>

    <div class="debug-section">
        <h2>Real-time Element Status</h2>
        <div id="element-status"></div>
    </div>

    <div class="debug-section">
        <h2>Debug Logs</h2>
        <div id="debug-logs"></div>
    </div>

    <div class="debug-section">
        <h2>Main App Container</h2>
        <div id="main-app-container"></div>
    </div>

    <script>
        let debugLogs = [];
        let elementWatchers = {};

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            debugLogs.push(logEntry);
            
            const logsContainer = document.getElementById('debug-logs');
            const logDiv = document.createElement('div');
            logDiv.className = type;
            logDiv.innerHTML = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logDiv);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            debugLogs = [];
            document.getElementById('debug-logs').innerHTML = '';
            console.clear();
            log('Logs cleared', 'info');
        }

        function checkElement(id, description = '') {
            const element = document.getElementById(id);
            const exists = !!element;
            const visible = exists ? getComputedStyle(element).display !== 'none' : false;
            
            const status = {
                id,
                exists,
                visible,
                description,
                element
            };
            
            if (exists) {
                status.tag = element.tagName.toLowerCase();
                status.classes = element.className;
                status.parent = element.parentElement ? element.parentElement.tagName.toLowerCase() : 'none';
            }
            
            return status;
        }

        function updateElementStatus() {
            const criticalElements = [
                { id: 'menu-grid', desc: 'Menu container' },
                { id: 'invoice-list', desc: 'Invoice list' },
                { id: 'order-items', desc: 'Order items container' },
                { id: 'sidebar', desc: 'Sidebar panel' },
                { id: 'order-modal', desc: 'Order creation modal' },
                { id: 'payment-modal', desc: 'Payment modal' },
                { id: 'admin-section', desc: 'Admin panel' },
                { id: 'end-shift-modal', desc: 'End shift modal' },
                { id: 'invoice-count', desc: 'Invoice counter' }
            ];

            const statusContainer = document.getElementById('element-status');
            statusContainer.innerHTML = '';

            criticalElements.forEach(({ id, desc }) => {
                const status = checkElement(id, desc);
                const statusDiv = document.createElement('div');
                statusDiv.className = 'element-check';
                
                let statusText = '';
                let statusClass = '';
                
                if (!status.exists) {
                    statusText = '❌ Missing';
                    statusClass = 'missing';
                } else if (!status.visible) {
                    statusText = '⚠️ Hidden';
                    statusClass = 'hidden';
                } else {
                    statusText = '✅ Found & Visible';
                    statusClass = 'found';
                }
                
                statusDiv.innerHTML = `
                    <span class="${statusClass}"><strong>${id}</strong> (${desc}): ${statusText}</span>
                    ${status.exists ? `<br>&nbsp;&nbsp;&nbsp;&nbsp;Tag: ${status.tag}, Parent: ${status.parent}` : ''}
                `;
                
                statusContainer.appendChild(statusDiv);
            });
        }

        function runFullDOMCheck() {
            log('Starting full DOM check...', 'info');
            
            log(`Document ready state: ${document.readyState}`, 'info');
            log(`Document title: "${document.title}"`, 'info');
            log(`Body children count: ${document.body ? document.body.children.length : 'No body'}`, 'info');
            
            // Check app container
            const appContainer = document.querySelector('.app-container');
            if (appContainer) {
                log(`✅ App container found with ${appContainer.children.length} children`, 'success');
                Array.from(appContainer.children).forEach((child, index) => {
                    const id = child.id ? `#${child.id}` : '';
                    const classes = child.className ? `.${child.className.split(' ').join('.')}` : '';
                    log(`   ${index + 1}. ${child.tagName}${classes}${id}`, 'info');
                });
            } else {
                log('❌ App container not found!', 'error');
            }
            
            // Update real-time status
            updateElementStatus();
            
            // Check for duplicate IDs
            const allIds = Array.from(document.querySelectorAll('[id]')).map(el => el.id);
            const duplicates = allIds.filter((id, index) => allIds.indexOf(id) !== index);
            if (duplicates.length > 0) {
                log(`⚠️ Duplicate IDs found: ${duplicates.join(', ')}`, 'warning');
            } else {
                log('✅ No duplicate IDs found', 'success');
            }
            
            log('Full DOM check completed', 'success');
        }

        function checkScriptLoading() {
            log('Checking script loading...', 'info');
            
            // Check if data.js loaded
            if (typeof window.menuData !== 'undefined') {
                log('✅ data.js loaded - menuData available', 'success');
                log(`   Menu items count: ${window.menuData.length}`, 'info');
            } else {
                log('❌ data.js not loaded - menuData missing', 'error');
            }
            
            if (typeof window.qrPaymentInfo !== 'undefined') {
                log('✅ data.js loaded - qrPaymentInfo available', 'success');
            } else {
                log('❌ data.js not loaded - qrPaymentInfo missing', 'error');
            }
            
            // Check if script.js loaded
            const scriptFunctions = [
                'renderMenu', 'addToOrder', 'createNewInvoice', 'openOrderModal',
                'confirmOrder', 'openPaymentModal', 'confirmPayment', 'updateOrderDisplay',
                'filterMenu', 'clearCurrentOrder', 'showNotification', 'toggleAdmin'
            ];
            
            let loadedFunctions = 0;
            scriptFunctions.forEach(func => {
                if (typeof window[func] === 'function') {
                    loadedFunctions++;
                } else {
                    log(`❌ Function missing: ${func}`, 'error');
                }
            });
            
            log(`✅ Script functions loaded: ${loadedFunctions}/${scriptFunctions.length}`, 
                loadedFunctions === scriptFunctions.length ? 'success' : 'warning');
            
            // Check global variables
            const globalVars = [
                'currentOrder', 'invoices', 'currentInvoiceId', 'currentCategory',
                'isAdminMode', 'orderHistory', 'shiftStartTime'
            ];
            
            let loadedVars = 0;
            globalVars.forEach(varName => {
                if (typeof window[varName] !== 'undefined') {
                    loadedVars++;
                    log(`✅ Global variable: ${varName} = ${JSON.stringify(window[varName])}`, 'success');
                } else {
                    log(`❌ Global variable missing: ${varName}`, 'error');
                }
            });
            
            log(`Global variables loaded: ${loadedVars}/${globalVars.length}`, 
                loadedVars === globalVars.length ? 'success' : 'warning');
        }

        function loadMainApp() {
            log('Loading main app HTML structure...', 'info');
            
            const mainContainer = document.getElementById('main-app-container');
            
            // Load the main app HTML
            fetch('index.html')
                .then(response => response.text())
                .then(html => {
                    // Extract body content
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const appContainer = doc.querySelector('.app-container');
                    
                    if (appContainer) {
                        mainContainer.innerHTML = appContainer.outerHTML;
                        log('✅ Main app HTML loaded successfully', 'success');
                        
                        // Load scripts
                        loadScript('data.js')
                            .then(() => loadScript('script.js'))
                            .then(() => {
                                log('✅ All scripts loaded', 'success');
                                setTimeout(() => {
                                    runFullDOMCheck();
                                    checkScriptLoading();
                                }, 1000);
                            })
                            .catch(error => {
                                log(`❌ Error loading scripts: ${error.message}`, 'error');
                            });
                    } else {
                        log('❌ Could not find app container in index.html', 'error');
                    }
                })
                .catch(error => {
                    log(`❌ Error loading index.html: ${error.message}`, 'error');
                });
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                log(`Loading script: ${src}`, 'info');
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    log(`✅ Script loaded: ${src}`, 'success');
                    resolve();
                };
                script.onerror = () => {
                    log(`❌ Script failed to load: ${src}`, 'error');
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        function exportDebugReport() {
            const report = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                debugLogs: debugLogs,
                domInfo: {
                    readyState: document.readyState,
                    title: document.title,
                    bodyChildren: document.body ? document.body.children.length : 0
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `balancoffee-debug-${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('Debug report exported', 'success');
        }

        // Start monitoring when page loads
        document.addEventListener('DOMContentLoaded', () => {
            log('DOM Debug Tool initialized', 'success');
            
            // Set up real-time monitoring
            setInterval(updateElementStatus, 2000);
            
            // Initial check
            setTimeout(runFullDOMCheck, 500);
        });

        // Monitor for changes
        if (typeof MutationObserver !== 'undefined') {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        log(`DOM mutation detected: ${mutation.addedNodes.length} nodes added`, 'info');
                        updateElementStatus();
                    }
                });
            });
            
            observer.observe(document.body, { childList: true, subtree: true });
        }
    </script>
</body>
</html>
